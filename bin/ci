#!/usr/bin/env bash
set -Eeuo pipefail

cd "$(git rev-parse --show-toplevel)"

export DISABLE_SPRING=1
export RAILS_ENV=${RAILS_ENV:-test}
export CI_LOCAL=1

echo "== Ruby deps =="
bundle check || bundle install

echo "== DB prepare =="
bin/rails db:prepare
RAILS_ENV=test bin/rails db:prepare

echo "== Code quality =="
mkdir -p tmp/rubocop_cache tmp/test-results
bundle exec rubocop --display-style-guide --cache true --cache-root tmp/rubocop_cache
bin/brakeman --no-pager
bin/importmap audit
bundle exec bundler-audit check --update || true

echo "== Safety checks =="
bin/rails zeitwerk:check
bin/rails strong_migrations:check || true

echo "== Tests =="
if [ -x bin/rspec ]; then
  bin/rspec \
    --force-color \
    --format progress \
    --format RspecJunitFormatter \
    --out tmp/test-results/rspec.xml
else
  bin/rails test
fi

# Optional frontend
# npm run -s tailwind:build:ci

echo "OK"
